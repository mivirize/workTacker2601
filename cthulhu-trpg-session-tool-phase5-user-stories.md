# Cthulhu Mythos TRPG Session Tool - Phase 5 詳細User Stories

## ドキュメント情報
- **作成日**: 2025年8月26日
- **対象**: Phase 5実装
- **優先度**: リアルタイムセッション機能最優先

## 現在の実装状況

### ✅ 実装済み機能
- **認証システム**: NextAuth.js + Google OAuth + デモ認証
- **データベース設計**: Prisma + SQLite（完全なスキーマ）
- **キャラクターシート管理**: CRUD操作、6版・7版対応、バリデーション
- **ダイス機能**: 完全なダイスロールシステム、クトゥルフ判定対応
- **AI描写補助機能**: OpenAI統合、キーワードベース生成
- **基本UI**: Button, Input, Modal等の共通コンポーネント
- **レイアウト**: Header, Sidebar, Footer
- **テーマシステム**: 基本的なスキン機能

### ⚠️ 部分実装機能
- **AI機能**: 描写補助のみ、他のAI機能は基盤のみ
- **セッション管理**: データベース設計完了、UI未実装
- **リアルタイム通信**: Socket.ioの基盤コード、実装未完了

### ❌ 未実装機能
- **シナリオ管理**: データ構造のみ、UI未実装
- **演出素材管理**: Cloudinary統合未完了
- **セッションルーム**: リアルタイム通信UI未実装
- **有料プラン管理**: Stripe等の決済システム未統合

---

## 優先度別機能分類 (MoSCoW Method)

### Must Have (Phase 5必須)
1. **リアルタイムセッション機能**
2. **マルチプレイヤー対応**

### Should Have (優先度高)
3. **AI機能完全実装**
4. **セッションログ機能**

### Could Have (追加価値)
5. **シナリオ管理システム**
6. **高度なUI/UX**

### Won't Have (Phase 5対象外)
7. **有料プラン管理**
8. **高度な演出機能**

---

# Epic 1: リアルタイムセッション基盤

## US-001: セッション作成機能

**As a** キーパー（KP）  
**I want to** 新しいセッションルームを作成する  
**So that** プレイヤーを招待してオンラインTRPGセッションを開始できる

### Acceptance Criteria:
- [ ] セッション作成フォームが表示される
- [ ] タイトル、最大参加者数、プライベート設定が入力できる
- [ ] セッションが正常に作成され、セッションIDが生成される
- [ ] 作成者が自動的にKPとして設定される
- [ ] 招待用URLが生成される

### Technical Requirements:
- POST `/api/sessions` エンドポイント
- [`Session`](prisma/schema.prisma:121) モデルの活用
- [`SessionParticipant`](prisma/schema.prisma:150) との関連

---

## US-002: セッション参加機能

**As a** プレイヤー  
**I want to** 招待URLまたはセッションIDでセッションに参加する  
**So that** 他のプレイヤーと一緒にTRPGを楽しめる

### Acceptance Criteria:
- [ ] セッション参加フォームが表示される
- [ ] セッションIDまたは招待URLで参加できる
- [ ] 参加時にキャラクターを選択できる
- [ ] 参加者一覧に表示される
- [ ] 最大参加者数の制限が適用される

### Technical Requirements:
- POST `/api/sessions/[id]/join` エンドポイント
- WebSocket接続の確立
- [`SessionParticipant`](prisma/schema.prisma:150) レコードの作成

---

## US-003: WebSocket通信基盤

**As a** システム開発者  
**I want to** 安定したWebSocket通信基盤を構築する  
**So that** リアルタイムデータ同期が確実に動作する

### Acceptance Criteria:
- [ ] Socket.ioサーバーが正常に起動する
- [ ] クライアント接続・切断が適切に処理される
- [ ] 接続状態の管理ができる
- [ ] エラーハンドリングが実装される
- [ ] 再接続機能が動作する

### Technical Requirements:
- [`Socket.io Server`](lib/socket.ts) の拡張
- 接続プール管理
- セッションルーム管理機能

---

# Epic 2: マルチプレイヤー通信

## US-004: リアルタイムチャット機能

**As a** セッション参加者  
**I want to** リアルタイムでメッセージを送受信する  
**So that** 他の参加者とスムーズにコミュニケーションできる

### Acceptance Criteria:
- [ ] チャット入力フォームが表示される
- [ ] メッセージが即座に全参加者に配信される
- [ ] 発言者名とタイムスタンプが表示される
- [ ] キャラクター発言とプレイヤー発言の区別ができる
- [ ] 過去のメッセージが保持される

### Technical Requirements:
- WebSocket `chat:message` イベント
- [`SessionLog`](prisma/schema.prisma:167) への記録
- リアルタイム配信機能

---

## US-005: ダイス結果同期機能

**As a** プレイヤー  
**I want to** ダイスロール結果が他の参加者にもリアルタイムで表示される  
**So that** 判定結果を全員で共有できる

### Acceptance Criteria:
- [ ] ダイスロール実行時に全参加者に結果が配信される
- [ ] 成功・失敗・クリティカル・ファンブルが視覚的に表示される
- [ ] シークレットロールはKPのみに表示される
- [ ] ダイス履歴がセッション内で共有される
- [ ] ロール理由とキャラクター情報が含まれる

### Technical Requirements:
- WebSocket `dice:roll` イベント
- [`DiceRoller`](components/dice/DiceRoller.tsx) の拡張
- 権限ベースの表示制御

---

## US-006: 参加者状態管理機能

**As a** キーパー  
**I want to** 参加者の接続状態とキャラクター情報を管理する  
**So that** セッションを適切に進行できる

### Acceptance Criteria:
- [ ] 参加者一覧が表示される
- [ ] オンライン・オフライン状態が表示される
- [ ] 各参加者のキャラクター情報が表示される
- [ ] KP権限で参加者を管理できる
- [ ] 接続状態の変化が即座に反映される

### Technical Requirements:
- WebSocket接続状態の監視
- 参加者一覧コンポーネント
- 権限管理システム

---

# Epic 3: AI機能拡張

## US-007: AIロールプレイ提案機能

**As a** プレイヤー  
**I want to** キャラクターの状況に応じたロールプレイ提案を受け取る  
**So that** より豊かなロールプレイができる

### Acceptance Criteria:
- [ ] 状況入力でロールプレイ提案が生成される
- [ ] SANチェック失敗時に自動提案が表示される
- [ ] 複数の選択肢が提示される
- [ ] キャラクター性格を考慮した提案がされる
- [ ] 提案をチャットに投稿できる

### Technical Requirements:
- POST `/api/ai/roleplay` エンドポイントの完全実装
- [`AIRoleplayAssistant`](components/ai/AIRoleplayAssistant.tsx) の実装
- キャラクター情報との連携

---

## US-008: AIあらすじ生成機能

**As a** セッション参加者  
**I want to** セッションログからあらすじを自動生成する  
**So that** セッションの記録を簡単に共有できる

### Acceptance Criteria:
- [ ] セッション終了後にあらすじ生成ができる
- [ ] Twitter投稿用の短縮版が生成される
- [ ] 詳細版のあらすじも生成される
- [ ] 重要な出来事が適切に抽出される
- [ ] 生成結果をSNSで共有できる

### Technical Requirements:
- POST `/api/ai/synopsis` エンドポイントの完全実装
- [`AISynopsisGenerator`](components/ai/AISynopsisGenerator.tsx) の実装
- SNS共有機能

---

## US-009: AI小説生成機能

**As a** セッション参加者  
**I want to** セッションログを小説形式に変換する  
**So that** セッションの思い出を読み物として保存できる

### Acceptance Criteria:
- [ ] チャットログが自然な会話に変換される
- [ ] ダイスロール結果が描写に変換される
- [ ] 章立てされた構成で出力される
- [ ] PDF/EPUB形式でダウンロードできる
- [ ] 生成進捗が表示される

### Technical Requirements:
- POST `/api/ai/novel` エンドポイントの完全実装
- [`AINovelGenerator`](components/ai/AINovelGenerator.tsx) の実装
- PDF生成ライブラリの統合

---

# Epic 4: セッション管理・ログ

## US-010: セッションログ記録機能

**As a** システム  
**I want to** セッション中の全ての活動を自動記録する  
**So that** 後から振り返りや二次創作に活用できる

### Acceptance Criteria:
- [ ] チャットメッセージが自動記録される
- [ ] ダイスロール結果が記録される
- [ ] キャラクター行動が記録される
- [ ] システムイベントが記録される
- [ ] タイムスタンプが正確に記録される

### Technical Requirements:
- [`SessionLog`](prisma/schema.prisma:167) への自動保存
- リアルタイムログ収集システム
- ログ種別の適切な分類

---

## US-011: ログ表示・検索機能

**As a** セッション参加者  
**I want to** 過去のセッションログを閲覧・検索する  
**So that** 必要な情報を素早く見つけられる

### Acceptance Criteria:
- [ ] セッションログが時系列で表示される
- [ ] キーワード検索ができる
- [ ] ログ種別でフィルタリングできる
- [ ] 特定の参加者の発言のみ表示できる
- [ ] 日時範囲での絞り込みができる

### Technical Requirements:
- [`SessionLogViewer`](components/session/SessionLogViewer.tsx) の完全実装
- 検索・フィルタリング機能
- ページネーション機能

---

## US-012: ログエクスポート機能

**As a** セッション参加者  
**I want to** セッションログを様々な形式でエクスポートする  
**So that** 外部ツールで活用できる

### Acceptance Criteria:
- [ ] テキスト形式でエクスポートできる
- [ ] JSON形式でエクスポートできる
- [ ] CSV形式でエクスポートできる
- [ ] エクスポート範囲を指定できる
- [ ] 大容量ログでも安定して処理できる

### Technical Requirements:
- GET `/api/sessions/[id]/logs/export` エンドポイントの完全実装
- 複数形式対応
- ストリーミング処理

---

# Epic 5: UI/UX完成

## US-013: 統合セッション画面

**As a** セッション参加者  
**I want to** 一つの画面でセッションの全機能を利用する  
**So that** 効率的にTRPGをプレイできる

### Acceptance Criteria:
- [ ] チャット、ダイス、キャラクターシートが1画面に表示される
- [ ] レイアウトをカスタマイズできる
- [ ] パネルの表示・非表示を切り替えられる
- [ ] 画面分割が適切に動作する
- [ ] 各機能間の連携がスムーズである

### Technical Requirements:
- セッションルームコンポーネント
- レスポンシブレイアウト
- 状態管理の統合

---

## US-014: レスポンシブデザイン

**As a** ユーザー  
**I want to** タブレット・スマートフォンでもセッションに参加する  
**So that** どこからでもTRPGを楽しめる

### Acceptance Criteria:
- [ ] タブレット表示が適切に動作する
- [ ] スマートフォン表示が適切に動作する
- [ ] タッチ操作が快適にできる
- [ ] 画面回転に対応する
- [ ] 主要機能がモバイルでも利用できる

### Technical Requirements:
- CSS Grid/Flexboxの活用
- タッチイベント対応
- モバイル専用UI調整

---

## US-015: アクセシビリティ対応

**As a** 障害を持つユーザー  
**I want to** スクリーンリーダー等の支援技術でツールを利用する  
**So that** 誰でも平等にTRPGを楽しめる

### Acceptance Criteria:
- [ ] 適切なARIA属性が設定される
- [ ] キーボードナビゲーションが動作する
- [ ] フォーカス表示が明確である
- [ ] 色だけでなく形やテキストで情報を伝える
- [ ] スクリーンリーダーで内容が理解できる

### Technical Requirements:
- ARIA属性の実装
- キーボードイベント対応
- セマンティックHTML

---

# 実装優先順位と依存関係

## フェーズ1: リアルタイム通信基盤 (2週間)
1. **US-003**: WebSocket通信基盤
2. **US-001**: セッション作成機能  
3. **US-002**: セッション参加機能

## フェーズ2: マルチプレイヤー機能 (2週間)
4. **US-004**: リアルタイムチャット機能
5. **US-005**: ダイス結果同期機能
6. **US-006**: 参加者状態管理機能

## フェーズ3: AI機能とログ (2週間)
7. **US-007**: AIロールプレイ提案機能
8. **US-008**: AIあらすじ生成機能
9. **US-010**: セッションログ記録機能

## フェーズ4: 統合とUI完成 (2週間)
10. **US-013**: 統合セッション画面
11. **US-011**: ログ表示・検索機能
12. **US-014**: レスポンシブデザイン

## オプション実装
13. **US-009**: AI小説生成機能
14. **US-012**: ログエクスポート機能  
15. **US-015**: アクセシビリティ対応

---

# テストケース作成指針

各User Storyについて、以下の観点でテストケースを作成：

1. **ユニットテスト**: 個別コンポーネント・API機能
2. **統合テスト**: WebSocket通信・データフロー
3. **E2Eテスト**: ユーザーシナリオ全体
4. **パフォーマンステスト**: 同時接続・大量データ処理
5. **セキュリティテスト**: 認証・認可・データ保護

このUser Storyドキュメントは、Phase 4でのテストケース作成とPhase 5での効率的な実装を支援するための詳細な指針となります。